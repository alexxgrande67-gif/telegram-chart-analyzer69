import os
import random
from PIL import Image
from google import genai

# --- 1. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Gemini ---
# ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ»ÑÑ‡ API Ğ¸Ğ· Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ Vercel
GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY")

if GEMINI_API_KEY:
    client = genai.Client(api_key=GEMINI_API_KEY)
else:
    client = None
    print("Ğ’ĞĞ˜ĞœĞĞĞ˜Ğ•: GEMINI_API_KEY Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ±ÑƒĞ´ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ—ĞĞ“Ğ›Ğ£Ğ¨ĞšĞ£.")

# --- 2. ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ´Ğ»Ñ Gemini ---
# Ğ§ĞµÑ‚ĞºĞ¸Ğµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ¾ Ñ‚Ğ¾Ğ¼, Ñ‡Ñ‚Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ.
PROMPT = """
ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ ÑĞ²ĞµÑ‡Ğ½Ğ¾Ğ¹ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº ĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ²Ğ°Ğ»ÑÑ‚Ñ‹. Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸:
1. Ğ˜Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞ¹ Ğ°ĞºÑ‚Ğ¸Ğ² Ğ¸ Ñ‚Ğ°Ğ¹Ğ¼Ñ„Ñ€ĞµĞ¹Ğ¼, ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ¸ Ğ²Ğ¸Ğ´Ğ½Ñ‹.
2. ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ñ†ĞµĞ½Ğ¾Ğ²Ñ‹Ğµ Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ (Ñ‚Ñ€ĞµĞ½Ğ´: Ğ²Ğ¾ÑÑ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¹, Ğ½Ğ¸ÑÑ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¹, Ğ±Ğ¾ĞºĞ¾Ğ²Ğ¾Ğ¹).
3. ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹ Ğ»ÑĞ±Ñ‹Ğµ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ñ‹ (MA, RSI Ğ¸ Ñ‚.Ğ´.) Ğ¸Ğ»Ğ¸ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹ ÑĞ²ĞµÑ‡ĞµĞ¹ (Ğ¼Ğ¾Ğ»Ğ¾Ñ‚, Ğ´Ğ¾Ğ´Ğ¶Ğ¸ Ğ¸ Ñ‚.Ğ´.).
4. Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞ¹ Ñ‡ĞµÑ‚ĞºĞ¸Ğ¹ Ğ¸ ĞºÑ€Ğ°Ñ‚ĞºĞ¸Ğ¹ **Ğ¢ĞĞ Ğ“ĞĞ’Ğ«Ğ™ Ğ¡Ğ˜Ğ“ĞĞĞ›** (ĞŸĞĞšĞ£ĞŸĞšĞ, ĞŸĞ ĞĞ”ĞĞ–Ğ Ğ¸Ğ»Ğ¸ ĞĞ•Ğ™Ğ¢Ğ ĞĞ›Ğ¬ĞĞ) Ñ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¼ Ğ¾Ğ±Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼.

ĞÑ‚Ğ²ĞµÑ‚ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ Markdown.
"""

# --- 3. Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ° ---
async def run_analysis(image_path: str) -> str:
    """
    ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ² Gemini API Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°.
    """
    if not client:
        # Ğ•ÑĞ»Ğ¸ API ĞºĞ»ÑÑ‡ Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ‚ÑƒÑ Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºÑƒ.
        signals = ["**Ğ¡Ğ˜Ğ“ĞĞĞ›: ĞĞ•Ğ™Ğ¢Ğ ĞĞ›Ğ¬ĞĞ** (Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°, Ğ½ĞµÑ‚ API ĞºĞ»ÑÑ‡Ğ° Gemini)", 
                   "**Ğ¡Ğ˜Ğ“ĞĞĞ›: ĞŸĞĞšĞ£ĞŸĞšĞ** (Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°, Ğ½ĞµÑ‚ API ĞºĞ»ÑÑ‡Ğ° Gemini)"]
        return f"âŒ **ĞĞ¨Ğ˜Ğ‘ĞšĞ API ĞšĞ›Ğ®Ğ§Ğ**\n{random.choice(signals)}"
    
    try:
        # 1. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ PIL
        img = Image.open(image_path)
        
        # 2. Ğ’Ñ‹Ğ·Ğ¾Ğ² Gemini API
        response = client.models.generate_content(
            model='gemini-2.5-flash', # ĞœĞ¾Ğ´ĞµĞ»ÑŒ, Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹
            contents=[PROMPT, img]
        )
        
        # 3. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
        return (
            f"ğŸ¤– **ĞÑ‚Ñ‡ĞµÑ‚ ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ° (Powered by Gemini)**\n"
            f"---"
            f"{response.text}"
        )

    except Exception as e:
        return f"âŒ **ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğµ Gemini API:**\n`{e}`"

# ĞĞ±Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ webhook.py
async def analyze_with_gemini(image_path: str) -> str:
    return await run_analysis(image_path)
